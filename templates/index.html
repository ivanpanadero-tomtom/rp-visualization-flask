<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Routing Points (RP) Visualization</title>
    <!-- Integrate Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">

    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Custom Styles */
        .rppa-box {
            text-align: center;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .legend-container img {
            max-width: 100%;
            height: auto;
        }

        .small-input {
            width: 100px; /* Adjust the width as needed */
        }

        /* Container for the RPPA box, map, and legend */
        .map-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .map-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }

        @media (max-width: 768px) {
            .rppa-box, .legend-container {
                width: 100%;
            }

            .map-iframe {
                height: 400px;
            }
        }

        .info-text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #343a40;
        }

        .monospace-select, 
        .monospace-select option {
            font-family: monospace;
            white-space: pre; /* preserve the spacing */
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Routing Points (RP) Visualization</h1>
        <form id="myForm">
            <!-- First Row: Country, Release Version, and Characteristic Distance -->
            <div class="row g-3">
                <!-- Select a Country -->
                <div class="col-md-4">
                    <label for="country" class="form-label">Select a Country:</label>
                    <select name="country" id="country" class="form-select">
                        <option value="">-- Select a Country --</option> <!-- Placeholder Option -->
                        {% for country in countries %}
                        <option value="{{ country }}" {% if country == selected_country %}selected{% endif %}>{{ country }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Select Release Version -->
                <div class="col-md-4">
                    <label for="release_version" class="form-label">Select Release Version:</label>
                    <select name="release_version" id="release_version" class="form-select">
                        <option value="">-- Select Release Version --</option> <!-- Optional Placeholder -->
                        {% for rv in release_versions %}
                        <option value="{{ rv }}" {% if rv == selected_version %}selected{% endif %}>{{ rv }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Characteristic Distance: Min & Max -->
                <div class="col-md-4">
                    <label class="form-label">Characteristic Distance (meters):</label>
                    <div class="row">
                        <!-- Min Characteristic Distance -->
                        <div class="col-6">
                            <input 
                                type="number" 
                                id="min_characteristic_distance" 
                                name="min_characteristic_distance" 
                                class="form-control" 
                                placeholder="Min"
                                min="0"
                            >
                        </div>
                        <!-- Max Characteristic Distance -->
                        <div class="col-6">
                            <input 
                                type="number" 
                                id="max_characteristic_distance" 
                                name="max_characteristic_distance" 
                                class="form-control" 
                                placeholder="Max"
                                min="0"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: RPPA, Routing Points Count, and Category -->
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label for="rppa" class="form-label">Select match:</label>
                    <select name="rppa" id="rppa" class="form-select">
                        <option value="">-- Select RPPA Match --</option> <!-- Optional Placeholder -->
                        {% for rppa in rrpa_list %}
                        <option value="{{ rppa }}" {% if rppa == selected_rppa %}selected{% endif %}>{{ rppa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="routing_points_count" class="form-label">Select Routing Points Count:</label>
                    <select name="routing_points_count" id="routing_points_count" class="form-select">
                        <option value="All">All</option>
                        {% for rpc in routing_points_counts %}
                        <option value="{{ rpc }}" {% if rpc == selected_routing_points_count %}selected{% endif %}>{{ rpc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="category" class="form-label">Select Category:</label>
                    <select name="category" id="category" class="form-select">
                        <option value="">-- Select Category --</option> <!-- Optional Placeholder -->
                        {% for category in categories %}
                        <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Third Row: POI Search Bar and Start/End Index -->
            <div class="row g-3 mt-3">
                <!-- POI Search Bar Column -->
                <div class="col-md-6">
                    <label for="poi-dropdown" class="form-label">Select a POI name:</label>
                    <div class="input-group mb-3">
                        <input type="text" id="poiSearch" placeholder="Search..." class="form-control">
                        <!-- "Show Map" Button Removed -->
                    </div>
                </div>
                
                <!-- Start/End Index and Total Loaded POIs Column -->
                <div class="col-md-6 d-flex justify-content-start align-items-end">
                    <div class="me-4">
                        <label for="start_index" class="form-label">Start Index:</label>
                        <input 
                            type="number" 
                            id="start_index" 
                            name="start_index" 
                            class="form-control small-input"
                            value="1"            
                            min="1" 
                            max="{{ len_df_pandas }}"
                        >
                    </div>
                    <div class="me-4">
                        <label for="end_index" class="form-label">End Index:</label>
                        <input 
                            type="number" 
                            id="end_index" 
                            name="end_index" 
                            class="form-control small-input"
                            value="100"           
                            min="1" 
                            max="{{ len_df_pandas }}"
                        >
                    </div>
                    <div class="ms-4">
                        <span>Total loaded POIs: <span id="total-pois">{{ len_df_pandas }}</span></span>
                    </div>
                </div>
            </div>

            <!-- Fourth Row: POI List -->
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <select name="poi" id="poi-dropdown" class="form-select monospace-select" size="10" required>
                        <option value=""> </option> <!-- Default empty option -->
                        {% for poi in pois %}
                            <option value="{{ poi.id }}" {% if selected_poi == poi.id %}selected{% endif %}>
                                {{ poi.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <div class="container-fluid p-0">
        <div id="mapContainer" class="map-container">
        </div>
    </div>

    <!-- Choices.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <!-- Integrate Bootstrap JS from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Choices.js on the country select element
            const countrySelect = document.getElementById('country');
            const countryChoices = new Choices(countrySelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Search for a country...',
                itemSelectText: '', // Removes the "Press to select" text
                shouldSort: true, // Sorts the dropdown options
                placeholderValue: '-- Select a Country --',
                noResultsText: 'No country found',
                noChoicesText: 'No countries available',
                renderChoiceLimit: -1, // Show all matching options
            });

            // Optionally, initialize Choices.js on other select elements
            /*
            const releaseVersionSelect = document.getElementById('release_version');
            const releaseVersionChoices = new Choices(releaseVersionSelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Search for a release version...',
                itemSelectText: '',
                shouldSort: true,
                placeholderValue: '-- Select Release Version --',
                noResultsText: 'No release version found',
                noChoicesText: 'No release versions available',
                renderChoiceLimit: -1,
            });

            const categorySelect = document.getElementById('category');
            const categoryChoices = new Choices(categorySelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Search for a category...',
                itemSelectText: '',
                shouldSort: true,
                placeholderValue: '-- Select Category --',
                noResultsText: 'No category found',
                noChoicesText: 'No categories available',
                renderChoiceLimit: -1,
            });
            */
        });

        // Existing JavaScript functions and event listeners
        let allPois = [];

        function updatePois() {
            // Grab the search string from the text input
            const searchQuery = document.getElementById('poiSearch').value;

            const country = document.getElementById('country').value;
            const releaseVersion = document.getElementById('release_version').value;
            const category = document.getElementById('category').value;
            const rppa = document.getElementById('rppa').value;
            const routingPointsCount = document.getElementById('routing_points_count').value;
            const startIndex = document.getElementById('start_index').value;
            const endIndex = document.getElementById('end_index').value;
            // New Characteristic Distance Values
            const minCharacteristicDistance = document.getElementById('min_characteristic_distance').value;
            const maxCharacteristicDistance = document.getElementById('max_characteristic_distance').value;

            const url = `/update_pois?country=${encodeURIComponent(country)}`
                        + `&release_version=${encodeURIComponent(releaseVersion)}`
                        + `&category=${encodeURIComponent(category)}`
                        + `&selected_rppa=${encodeURIComponent(rppa)}`
                        + `&routing_points_count=${encodeURIComponent(routingPointsCount)}`
                        + `&start_index=${encodeURIComponent(startIndex)}`
                        + `&end_index=${encodeURIComponent(endIndex)}`
                        + `&search=${encodeURIComponent(searchQuery)}`
                        + `&min_characteristic_distance=${encodeURIComponent(minCharacteristicDistance)}`
                        + `&max_characteristic_distance=${encodeURIComponent(maxCharacteristicDistance)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Update POIs
                    allPois = data.pois;
                    renderPois(allPois);

                    // Update other dropdowns...
                    const rppaSelect = document.getElementById('rppa');
                    rppaSelect.innerHTML = '';
                    // Add a placeholder option
                    const rppaPlaceholder = document.createElement('option');
                    rppaPlaceholder.value = "";
                    rppaPlaceholder.textContent = "-- Select RPPA Match --";
                    rppaSelect.appendChild(rppaPlaceholder);
                    data.rrpa_list.forEach(rrpaValue => {
                        const option = document.createElement('option');
                        option.value = rrpaValue;
                        option.textContent = rrpaValue;
                        if (rrpaValue === data.selected_rppa) {
                            option.selected = true;
                        }
                        rppaSelect.appendChild(option);
                    });

                    document.getElementById('total-pois').textContent = data.len_df_pandas;

                    // Update Routing Points Count dropdown
                    const rpcSelect = document.getElementById('routing_points_count');
                    rpcSelect.innerHTML = '';
                    const allOption = document.createElement('option');
                    allOption.value = 'All';
                    allOption.textContent = 'All';
                    if (data.selected_routing_points_count === 'All') {
                        allOption.selected = true;
                    }
                    rpcSelect.appendChild(allOption);

                    data.routing_points_counts.forEach(rpcValue => {
                        const option = document.createElement('option');
                        option.value = rpcValue;
                        option.textContent = rpcValue;
                        if (rpcValue === data.selected_routing_points_count) {
                            option.selected = true;
                        }
                        rpcSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching POIs:', error));
        }

        function renderPois(pois) {
            const poiSelect = document.getElementById('poi-dropdown');
            poiSelect.innerHTML = '<option value=""></option>'; // Reset options

            pois.forEach(poi => {
                const option = document.createElement('option');
                option.value = poi.id;          // Use poi.id as the value
                option.textContent = poi.label; // Display poi.label as the text
                poiSelect.appendChild(option);
            });
        }

        // Event Listeners
        document.getElementById('country').addEventListener('change', updatePois);
        document.getElementById('release_version').addEventListener('change', updatePois);
        document.getElementById('category').addEventListener('change', updatePois);
        document.getElementById('rppa').addEventListener('change', updatePois);
        document.getElementById('routing_points_count').addEventListener('change', updatePois);
        document.getElementById('min_characteristic_distance').addEventListener('input', updatePois);
        document.getElementById('max_characteristic_distance').addEventListener('input', updatePois);

        // Event listeners for Start Index and End Index
        document.getElementById('start_index').addEventListener('change', updatePois);
        document.getElementById('end_index').addEventListener('change', updatePois);

        // POI Search Input
        document.getElementById('poiSearch').addEventListener('input', function() {
            updatePois();
        });

        // Form Submission on Double Click of POI Dropdown
        document.getElementById('poi-dropdown').addEventListener('dblclick', function() {
            document.getElementById('myForm').dispatchEvent(new Event('submit'));
        });

        // Handle Form Submission
        document.getElementById('myForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            const rppa = document.getElementById('rppa').value;
            const routingPointsCount = document.getElementById('routing_points_count').value; // New filter

            // Prevent form submission if Min > Max
            const minDistance = parseFloat(document.getElementById('min_characteristic_distance').value) || 0;
            const maxDistance = parseFloat(document.getElementById('max_characteristic_distance').value) || Infinity;

            if (minDistance > maxDistance) {
                event.preventDefault();
                alert('Minimum Characteristic Distance cannot be greater than Maximum Characteristic Distance.');
                return;
            }

            // Add the current selected_rppa and routing_points_count values to the form data
            formData.append('selected_rppa', rppa);
            formData.append('routing_points_count', routingPointsCount);

            fetch('/get_map', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    const mapContainer = document.getElementById('mapContainer');
                    if (data.error) {
                        mapContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }

                    mapContainer.innerHTML = `
                        <div class="map-container">
                            <div class="rppa-box" style="background-color: ${data.rppa_color};">
                                ${data.poi_name} - ${data.poi_category} - RPPA: ${data.rppa}
                            </div>
                            <div class="map-wrapper w-100 mb-3">
                                ${data.map_html}
                            </div>
                            <div class="legend-container">
                                <img src="{{ url_for('static', filename='images/legend.png') }}" alt="Legend">
                            </div>
                        </div>
                    `;
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>

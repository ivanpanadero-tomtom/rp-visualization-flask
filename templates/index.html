<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Routing Points (RP) Visualization</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
.rppa-box {
    text-align: center;
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px; /* reduced margin for tighter spacing */
    width: 100%; /* match container width */
}

#poi {
    width: 400px;
    overflow-y: auto;
}

/* Container for the RPPA box, legend, and map */
.map-container {
    width: 800px; /* fixed width to match map and legend */
    margin-top: 20px; 
}

/* Center the legend and give some spacing */
.legend-container {
    text-align: center;
    margin: 10px 0;
}
</style>
</head>
<body>
<h1>Routing Points (RP) Visualization</h1>
<form id="myForm">
    <label for="country">Select a country:</label><br>
    <select name="country" id="country">
        {% for country in countries %}
        <option value="{{ country }}" {% if country == selected_country %}selected{% endif %}>{{ country }}</option>
        {% endfor %}
    </select><br><br>

    <label for="release_version">Select Release Version:</label><br>
    <select name="release_version" id="release_version">
        {% for rv in release_versions %}
        <option value="{{ rv }}" {% if rv == selected_version %}selected{% endif %}>{{ rv }}</option>
        {% endfor %}
    </select><br><br>

    <label for="poi">Select a POI:</label><br>
    <!-- Search box to filter POIs -->
    <input type="text" id="poiSearch" placeholder="Search..." style="width:200px; margin-bottom:5px;"><br>
    <select name="poi" id="poi" size="10">
        {% for p in pois %}
        <option value="{{ p }}" {% if p == selected_poi %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
    </select><br><br>

    <button type="submit">Show Map</button>
</form>

<div id="mapContainer"></div>

<script>
let allPois = []; // Will store all POIs fetched from the server

// Update POI options when country or release_version changes
function updatePois() {
    const country = document.getElementById('country').value;
    const releaseVersion = document.getElementById('release_version').value;
    const url = `/update_pois?country=${encodeURIComponent(country)}&release_version=${encodeURIComponent(releaseVersion)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Store all the POIs in an array
            allPois = data.pois;
            // Initially display all POIs
            renderPois(allPois);
        })
        .catch(error => console.error('Error fetching POIs:', error));
}

// Render POIs into the select element
function renderPois(pois) {
    const poiSelect = document.getElementById('poi');
    poiSelect.innerHTML = '';
    pois.forEach(p => {
        const option = document.createElement('option');
        option.value = p;
        option.textContent = p;
        poiSelect.appendChild(option);
    });
}

// Filter POIs based on the search input
function filterPois() {
    const searchQuery = document.getElementById('poiSearch').value.toLowerCase();
    const filtered = allPois.filter(p => p.toLowerCase().includes(searchQuery));
    renderPois(filtered);
}

// Event listeners for country and release version changes
document.getElementById('country').addEventListener('change', updatePois);
document.getElementById('release_version').addEventListener('change', updatePois);

// Event listener for the search input
document.getElementById('poiSearch').addEventListener('input', filterPois);

// Handle form submission via AJAX to show the map
document.getElementById('myForm').addEventListener('submit', function(event){
    event.preventDefault();
    const formData = new FormData(this);

    fetch('/get_map', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const mapContainer = document.getElementById('mapContainer');
        if (data.error) {
            mapContainer.innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
        }
        
        // Create a container to hold the RPPA box, legend, and map together
        mapContainer.innerHTML = `
            <div class="map-container">
                <div class="rppa-box" style="background-color: ${data.rppa_color};">
                    RPPA: ${data.rppa}
                </div>
                <div class="legend-container">
                    <img src="{{ url_for('static', filename='images/legend.png') }}" alt="Legend" width="400">
                </div>
                ${data.map_html}
            </div>
        `;
    })
    .catch(error => console.error('Error:', error));
});
</script>

</body>
</html>

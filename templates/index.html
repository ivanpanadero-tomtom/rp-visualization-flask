<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Routing Points (RP) Visualization</title>
    <!-- Integrate Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Custom Styles */
        .rppa-box {
            text-align: center;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .legend-container img {
            max-width: 100%;
            height: auto;
        }

        /* Container for the RPPA box, map, and legend */
        .map-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .map-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }

        @media (max-width: 768px) {
            .rppa-box, .legend-container {
                width: 100%;
            }

            .map-iframe {
                height: 400px;
            }
        }

        .info-text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #343a40;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Routing Points (RP) Visualization</h1>
        <form id="myForm">
            <!-- First Row: Country and Release Version -->
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="country" class="form-label">Select a Country:</label>
                    <select name="country" id="country" class="form-select">
                        {% for country in countries %}
                        <option value="{{ country }}" {% if country == selected_country %}selected{% endif %}>{{ country }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="release_version" class="form-label">Select Release Version:</label>
                    <select name="release_version" id="release_version" class="form-select">
                        {% for rv in release_versions %}
                        <option value="{{ rv }}" {% if rv == selected_version %}selected{% endif %}>{{ rv }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Second Row: RPPA, Routing Points Count, and Category -->
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label for="rppa" class="form-label">Select RPPA:</label>
                    <select name="rppa" id="rppa" class="form-select">
                        {% for rppa in rrpa_list %}
                        <option value="{{ rppa }}" {% if rppa == selected_rppa %}selected{% endif %}>{{ rppa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="routing_points_count" class="form-label">Select Routing Points Count:</label>
                    <select name="routing_points_count" id="routing_points_count" class="form-select">
                        <option value="All">All</option>
                        {% for rpc in routing_points_counts %}
                        <option value="{{ rpc }}" {% if rpc == selected_routing_points_count %}selected{% endif %}>{{ rpc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="category" class="form-label">Select Category:</label>
                    <select name="category" id="category" class="form-select">
                        {% for category in categories %}
                        <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Third Row: POI Selection -->
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="poi" class="form-label">Select a POI:</label>
                    <div class="input-group mb-3">
                        <input type="text" id="poiSearch" placeholder="Search..." class="form-control">
                        <button type="submit" class="btn btn-primary">Show Map</button>
                    </div>
                    <div class="info-text">
                        POI name - POI Category - [#RPs Reference, #RPs Provider] - RPPA = X:
                    </div>
                    <select name="poi" id="poi" size="10" class="form-select">
                        {% for p in pois %}
                        <option value="{{ p }}" {% if p == selected_poi %}selected{% endif %}>{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <div class="container-fluid p-0">
        <div id="mapContainer" class="map-container">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allPois = [];

        function updatePois() {
            const country = document.getElementById('country').value;
            const releaseVersion = document.getElementById('release_version').value;
            const category = document.getElementById('category').value;
            const rppa = document.getElementById('rppa').value;
            const routingPointsCount = document.getElementById('routing_points_count').value; // New filter

            const url = `/update_pois?country=${encodeURIComponent(country)}&release_version=${encodeURIComponent(releaseVersion)}&category=${encodeURIComponent(category)}&selected_rppa=${encodeURIComponent(rppa)}&routing_points_count=${encodeURIComponent(routingPointsCount)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching POIs:', data.error);
                        return;
                    }

                    // Update POIs
                    allPois = data.pois;
                    renderPois(allPois);

                    // Update RPPA dropdown
                    const rppaSelect = document.getElementById('rppa');
                    rppaSelect.innerHTML = '';
                    data.rrpa_list.forEach(rrpaValue => {
                        const option = document.createElement('option');
                        option.value = rrpaValue;
                        option.textContent = rrpaValue;
                        if (rrpaValue === data.selected_rppa) {
                            option.selected = true; // Retain the selected value
                        }
                        rppaSelect.appendChild(option);
                    });

                    // Update Routing Points Count dropdown
                    const rpcSelect = document.getElementById('routing_points_count');
                    rpcSelect.innerHTML = '';
                    const allOption = document.createElement('option');
                    allOption.value = 'All';
                    allOption.textContent = 'All';
                    if (data.selected_routing_points_count === 'All') {
                        allOption.selected = true;
                    }
                    rpcSelect.appendChild(allOption);

                    data.routing_points_counts.forEach(rpcValue => {
                        const option = document.createElement('option');
                        option.value = rpcValue;
                        option.textContent = rpcValue;
                        if (rpcValue === data.selected_routing_points_count) {
                            option.selected = true;
                        }
                        rpcSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching POIs:', error));
        }

        function renderPois(pois) {
            const poiSelect = document.getElementById('poi');
            poiSelect.innerHTML = '';
            pois.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                poiSelect.appendChild(option);
            });
        }

        document.getElementById('country').addEventListener('change', updatePois);
        document.getElementById('release_version').addEventListener('change', updatePois);
        document.getElementById('category').addEventListener('change', updatePois);
        document.getElementById('rppa').addEventListener('change', updatePois);
        document.getElementById('routing_points_count').addEventListener('change', updatePois); // New event listener

        document.getElementById('poiSearch').addEventListener('input', function() {
            const searchQuery = document.getElementById('poiSearch').value.toLowerCase();
            const filtered = allPois.filter(p => p.toLowerCase().includes(searchQuery));
            renderPois(filtered);
        });

        document.addEventListener('DOMContentLoaded', updatePois);

        document.getElementById('myForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            const rppa = document.getElementById('rppa').value;
            const routingPointsCount = document.getElementById('routing_points_count').value; // New filter

            // Add the current selected_rppa and routing_points_count values to the form data
            formData.append('selected_rppa', rppa);
            formData.append('routing_points_count', routingPointsCount);

            fetch('/get_map', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    const mapContainer = document.getElementById('mapContainer');
                    if (data.error) {
                        mapContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }

                    mapContainer.innerHTML = `
                        <div class="map-container">
                            <div class="rppa-box" style="background-color: ${data.rppa_color};">
                                ${data.poi_name} - ${data.poi_category} - RPPA: ${data.rppa}
                            </div>
                            <div class="map-wrapper w-100 mb-3">
                                ${data.map_html}
                            </div>
                            <div class="legend-container">
                                <img src="{{ url_for('static', filename='images/legend.png') }}" alt="Legend">
                            </div>
                        </div>
                    `;
                })
                .catch(error => console.error('Error:', error));
        });

        document.getElementById('poi').addEventListener('dblclick', function() {
            document.getElementById('myForm').dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>
